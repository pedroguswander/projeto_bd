<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualizar Obra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body { padding-top: 5rem; }
    </style>
</head>
<body>

<nav th:replace="~{index :: nav}"></nav>

<div class="container">
    <h1 class="mt-5 text-center">Atualizar Obra</h1>

    <div class="card my-4 p-4">
        <h2 class="card-title text-center border-bottom pb-3 mb-4">1. Encontre a Obra</h2>
        <form id="searchForm">
            <div class="mb-3">
                <label for="idBusca" class="form-label">Digite o ID da obra que deseja atualizar:</label>
                <input type="number" class="form-control" id="idBusca" name="idBusca" required>
            </div>
            <button type="submit" class="btn btn-secondary w-100">Buscar Obra</button>
        </form>
    </div>

    <div id="responseMessage" class="alert d-none" role="alert"></div>

    <div class="card my-4 p-4" id="updateFormCard" style="display: none;">
        <h2 class="card-title text-center border-bottom pb-3 mb-4">2. Modifique os Dados</h2>
        <form id="updateForm">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome da Obra:</label>
                <input type="text" class="form-control" id="nome" name="nome" required>
            </div>

            <div class="mb-3">
                <label for="sinopse" class="form-label">Sinopse:</label>
                <textarea class="form-control" id="sinopse" name="sinopse"></textarea>
            </div>

            <div class="mb-3">
                <label for="data_lancamento" class="form-label">Data de Lançamento:</label>
                <input type="date" class="form-control" id="data_lancamento" name="data_lancamento">
            </div>

            <div class="mb-3">
                <label for="fk_genero_genero_PK" class="form-label">ID do Gênero (fk_genero_genero_PK):</label>
                <input type="number" class="form-control" id="fk_genero_genero_PK" name="fk_genero_genero_PK" required>
            </div>

            <div class="mb-3">
                <label for="obra_TIPO" class="form-label">Tipo da Obra (Ex: 1 para Filme, 2 para Série):</label>
                <input type="number" class="form-control" id="obra_TIPO" name="obra_TIPO">
            </div>

            <div class="mb-3">
                <label for="qnt_temporadas" class="form-label">Quantidade de Temporadas (se aplicável):</label>
                <input type="number" class="form-control" id="qnt_temporadas" name="qnt_temporadas">
            </div>

            <div class="mb-3">
                <label for="duracao" class="form-label">Duração (hh:mm:ss):</label>
                <input type="time" class="form-control" id="duracao" name="duracao" step="1">
            </div>

            <button type="submit" class="btn btn-primary w-100">Atualizar Obra</button>
        </form>
    </div>
</div>

<script>
    let currentObraId = null;

    const searchForm = document.getElementById('searchForm');
    const updateFormCard = document.getElementById('updateFormCard');
    const updateForm = document.getElementById('updateForm');
    const messageDiv = document.getElementById('responseMessage');

    function showMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
        messageDiv.classList.remove('d-none');
    }

    function populateForm(obra) {
        document.getElementById('nome').value = obra.nome || '';
        document.getElementById('sinopse').value = obra.sinopse || '';
        if (obra.dataLancamento) {
            document.getElementById('data_lancamento').value = obra.dataLancamento.split('T')[0];
        } else {
            document.getElementById('data_lancamento').value = '';
        }
        document.getElementById('fk_genero_genero_PK').value = obra.fkGeneroGeneroPK || '';
        document.getElementById('obra_TIPO').value = obra.obraTIPO || '';
        document.getElementById('qnt_temporadas').value = obra.qntTemporadas || '';
        document.getElementById('duracao').value = obra.duracao || '';
    }

    searchForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const obraId = document.getElementById('idBusca').value;

        messageDiv.classList.add('d-none');
        updateFormCard.style.display = 'none';

        if (!obraId) {
            showMessage('Por favor, insira um ID para buscar.', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/obras/${obraId}`);
            if (response.ok) {
                const obra = await response.json();
                currentObraId = obra.codigo;
                populateForm(obra);
                updateFormCard.style.display = 'block';
                showMessage('Obra encontrada. Você já pode editar os dados abaixo.', 'success');
            } else if (response.status === 404) {
                showMessage(`Erro: Obra com ID ${obraId} não encontrada.`, 'error');
            } else {
                const errorText = await response.text();
                showMessage(`Erro ao buscar obra: ${errorText || response.statusText}`, 'error');
            }
        } catch (error) {
            showMessage('Erro de rede ou ao conectar com o servidor: ' + error.message, 'error');
        }
    });

    updateForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        if (!currentObraId) {
            showMessage('ID da obra não definido. Realize a busca novamente.', 'error');
            return;
        }

        const formData = new FormData(this);
        const obraAtualizada = {
            id: currentObraId,
            nome: formData.get('nome'),
            sinopse: formData.get('sinopse'),
            dataLancamento: formData.get('data_lancamento'),
            fkGeneroGeneroPK: parseInt(formData.get('fk_genero_genero_PK'), 10),
            obraTIPO: parseInt(formData.get('obra_TIPO'), 10),
            qntTemporadas: formData.get('qnt_temporadas') ? parseInt(formData.get('qnt_temporadas'), 10) : null,
            duracao: formData.get('duracao') || null
        };

        try {
            const response = await fetch(`/api/obras/${currentObraId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(obraAtualizada)
            });

            const responseText = await response.text();

            if (response.ok) {
                showMessage("Obra atualizada com sucesso!", 'success');
                updateFormCard.style.display = 'none';
                searchForm.reset();
            } else {
                showMessage(`Erro ao atualizar: ${responseText || response.statusText}`, 'error');
            }
        } catch (error) {
            showMessage('Erro de rede ou ao conectar com o servidor: ' + error.message, 'error');
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>